#!/bin/bash
# .git/hooks/pre-commit
#
# This hook is executed before a commit is made.
# It runs essential checks to ensure code quality and security.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "${YELLOW}üîç Running pre-commit checks...${NC}"

# CRITICAL: Prevent direct commits to main/master branches
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo "${RED}‚ùå ERROR: Direct commits to '$CURRENT_BRANCH' branch are not allowed!${NC}"
    echo "${RED}Please create a feature branch and use a pull request instead.${NC}"
    echo ""
    echo "${YELLOW}To fix this:${NC}"
    echo "  1. Create a new branch: git checkout -b feature/your-feature-name"
    echo "  2. Make your changes and commit"
    echo "  3. Push the branch: git push origin feature/your-feature-name"
    echo "  4. Create a pull request to merge into $CURRENT_BRANCH"
    echo ""
    exit 1
fi

# Load shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/shared/security-check.sh"
source "$SCRIPT_DIR/shared/quality-checks.sh"

# CRITICAL: Check for sensitive data in staged files
if ! check_staged_files; then
    exit 1
fi

# Detect project type
PROJECT_INFO=$(detect_project_type)
REPO_NAME=$(echo "$PROJECT_INFO" | cut -d'|' -f1)
IS_RAILS_PROJECT=$(echo "$PROJECT_INFO" | cut -d'|' -f2)
IS_TYPESCRIPT_PROJECT=$(echo "$PROJECT_INFO" | cut -d'|' -f3)

# Run TypeScript check
if [ "$IS_TYPESCRIPT_PROJECT" = "true" ]; then
    if ! run_typescript_check "$REPO_NAME"; then
        exit 1
    fi
fi

# Run linting
if [ -f "package.json" ]; then
    if ! run_linting "$REPO_NAME"; then
        exit 1
    fi
fi

# Skip Cypress tests in pre-commit (run in pre-push instead for better performance)
echo "${YELLOW}üí° Cypress tests will run during pre-push for better performance${NC}"

echo "${GREEN}üéâ All pre-commit checks passed!${NC}"
exit 0
