#!/bin/sh
# .git/hooks/pre-push
#
# This hook prevents pushing directly to main branch.
# All changes should go through feature branches and pull requests.

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get the remote name and URL from arguments
remote="$1"
url="$2"

# Read ref information from stdin
while read local_ref local_oid remote_ref remote_oid
do
    # Extract branch name from local_ref (format: refs/heads/branch-name)
    local_branch=$(echo "$local_ref" | sed 's|refs/heads/||')
    
    # Extract branch name from remote_ref (format: refs/heads/branch-name)
    remote_branch=$(echo "$remote_ref" | sed 's|refs/heads/||')
    
    # Check if pushing to main branch
    if [ "$remote_branch" = "main" ] || [ "$remote_branch" = "master" ]; then
        # Allow pushing to Heroku main (deployment use case)
        if echo "$url" | grep -q "heroku" || [ "$remote" = "heroku" ]; then
            echo "${YELLOW}⚠️  Pushing to Heroku main (allowed for deployment)${NC}"
            continue
        fi
        
        # Block pushing to origin/main
        echo "${RED}❌ ERROR: Direct push to ${remote_branch} branch is not allowed!${NC}"
        echo ""
        echo "${YELLOW}Please use a feature branch and create a pull request instead:${NC}"
        echo ""
        echo "  ${BLUE}1. Create a feature branch:${NC}"
        echo "     git checkout -b feature/your-feature-name"
        echo ""
        echo "  ${BLUE}2. Make your changes and commit:${NC}"
        echo "     git add ."
        echo "     git commit -m 'Your commit message'"
        echo ""
        echo "  ${BLUE}3. Push to your branch:${NC}"
        echo "     git push origin feature/your-feature-name"
        echo ""
        echo "  ${BLUE}4. Create a pull request on GitHub${NC}"
        echo ""
        echo "${RED}If you really need to push directly to main (emergency hotfix),${NC}"
        echo "${RED}you can bypass this hook with:${NC}"
        echo "${YELLOW}  git push --no-verify origin main${NC}"
        echo ""
        exit 1
    fi
done

exit 0

