#!/bin/bash
# .git/hooks/pre-push
#
# This hook is executed before a push is made.
# It runs comprehensive checks to ensure code quality and security.

# Colors for output (only if outputting to a terminal)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

echo "${BLUE}ðŸš€ Running pre-push checks...${NC}"

# CRITICAL: Prevent direct pushes to main/master branches (except Heroku deployments)
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
REMOTE_NAME="$1"

# Allow pushes to Heroku remote (for deployments)
if [ "$REMOTE_NAME" != "heroku" ] && ([ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]); then
    echo "${RED}âŒ ERROR: Direct pushes to '$CURRENT_BRANCH' branch are not allowed!${NC}"
    echo "${RED}Please create a feature branch and use a pull request instead.${NC}"
    echo ""
    echo "${YELLOW}To fix this:${NC}"
    echo "  1. Create a new branch: git checkout -b feature/your-feature-name"
    echo "  2. Make your changes and commit"
    echo "  3. Push the branch: git push origin feature/your-feature-name"
    echo "  4. Create a pull request to merge into $CURRENT_BRANCH"
    echo ""
    exit 1
fi

# Load shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/shared/security-check.sh"
source "$SCRIPT_DIR/shared/quality-checks.sh"

# CRITICAL: Check for sensitive data in commits being pushed
COMMITS_TO_CHECK=""
while read local_ref local_sha remote_ref remote_sha; do
    if [ "$local_sha" != "0000000000000000000000000000000000000000" ]; then
        COMMITS_TO_CHECK="$COMMITS_TO_CHECK $local_sha"
    fi
done

if ! check_commits "$COMMITS_TO_CHECK"; then
    exit 1
fi

# Detect project type
PROJECT_INFO=$(detect_project_type)
REPO_NAME=$(echo "$PROJECT_INFO" | cut -d'|' -f1)
IS_RAILS_PROJECT=$(echo "$PROJECT_INFO" | cut -d'|' -f2)
IS_TYPESCRIPT_PROJECT=$(echo "$PROJECT_INFO" | cut -d'|' -f3)

# Skip TypeScript and linting checks (already run in pre-commit)
echo "${YELLOW}ðŸ’¡ TypeScript and linting checks already passed in pre-commit${NC}"

# Check if pushing to Heroku (skip Cypress tests for Heroku deployments)
REMOTE_URL=$(git remote get-url "$REMOTE_NAME" 2>/dev/null || git remote get-url heroku 2>/dev/null)
IS_HEROKU_PUSH=false
if echo "$REMOTE_URL" | grep -q "heroku"; then
    IS_HEROKU_PUSH=true
    echo "${BLUE}ðŸŽ¯ Pushing to Heroku - skipping local Cypress tests${NC}"
    echo "${YELLOW}ðŸ’¡ Tests will run against deployed Heroku app with: npm run test:heroku${NC}"
else
    # Run Cypress tests for non-Heroku pushes
    # COMMENTED OUT: Temporarily skipping Cypress tests
    # IS_MAIN_BRANCH="false"
    # if [ "$1" = "refs/heads/main" ] || [ "$1" = "refs/heads/master" ]; then
    #     IS_MAIN_BRANCH="true"
    # fi

    # if ! run_cypress_tests "$IS_MAIN_BRANCH"; then
    #     exit 1
    # fi
    echo "${YELLOW}ðŸ’¡ Cypress tests skipped (temporarily commented out)${NC}"
fi

# Run build check for Heroku deployments
if [ "$IS_HEROKU_PUSH" = true ]; then
    echo "${BLUE}ðŸŽ¯ Ensuring production readiness...${NC}"
    
    if ! run_build_check; then
        exit 1
    fi
fi

echo "${GREEN}ðŸŽ‰ All pre-push checks passed!${NC}"
exit 0
